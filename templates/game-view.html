{% extends "base.html" %}

{% block title %}{{ game.title }} - Secret Santa{% endblock %}

{% block content %}
<div class="game-view-container">
    <div class="games-header">
        <div class="game-title-section">
            <h1>{{ game.title }}</h1>
            <div class="game-meta-badges">
                <span class="game-status status-{{ game.status }}">{{ game.status }}</span>
                {% if game.organizer_id == current_user.id %}
                <span class="game-role organizer">üëë –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                {% else %}
                <span class="game-role participant">üéÖ –£—á–∞—Å—Ç–Ω–∏–∫</span>
                {% endif %}
                {% if game.is_private %}
                <span class="privacy-badge private">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</span>
                {% else %}
                <span class="privacy-badge public">üåê –ü—É–±–ª–∏—á–Ω–∞—è</span>
                {% endif %}
            </div>
        </div>
        
        <div class="game-header-actions">
            <a href="/games" class="btn btn-outline">‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º</a>
        </div>
    </div>

    <div class="game-content-sections">
        <div class="content-sections">
            {% if game.description %}
            <section class="content-section">
                <h2>üìñ –û–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã</h2>
                <div class="description-content">
                    {{ game.description }}
                </div>
            </section>
            {% endif %}

            <section class="content-section">
                <h2>üìä –î–µ—Ç–∞–ª–∏ –∏–≥—Ä—ã</h2>
                <div class="details-grid">
                    <div class="detail-card">
                        <div class="detail-icon">üëë</div>
                        <div class="detail-info">
                            <span class="detail-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                            <span class="detail-value">{{ game.organizer.username or game.organizer.email }}</span>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-icon">üìÖ</div>
                        <div class="detail-info">
                            <span class="detail-label">–î–∞—Ç–∞ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏</span>
                            <span class="detail-value">
                                {% if game.event_date %}
                                    {{ game.event_date.strftime('%d.%m.%Y –≤ %H:%M') }}
                                {% else %}
                                    –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if game.budget %}
                    <div class="detail-card">
                        <div class="detail-icon">üí∞</div>
                        <div class="detail-info">
                            <span class="detail-label">–ë—é–¥–∂–µ—Ç –ø–æ–¥–∞—Ä–∫–∞</span>
                            <span class="detail-value">{{ game.budget }} —Ä—É–±.</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="detail-card">
                        <div class="detail-icon">üë•</div>
                        <div class="detail-info">
                            <span class="detail-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                            <span class="detail-value">{{ game.participants|length }}</span>
                        </div>
                    </div>
                </div>
            </section>

            {% if game.organizer_id == current_user.id %}
            <section class="content-section">
                <h2>üîë –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á</h2>
                <div class="secret-key-section">
                    <div class="key-display">
                        <span class="key-label">–ö–ª—é—á –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:</span>
                        <span class="key-value">{{ game.secret_key }}</span>
                        <button class="btn-copy" onclick="copyKey('{{ game.secret_key }}')">üìã</button>
                    </div>
                    <div class="form-hint">
                        üí° –ü–æ–¥–µ–ª–∏—Å—å —ç—Ç–∏–º –∫–ª—é—á–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –º–æ–≥–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
                    </div>
                </div>
            </section>
            <section class="content-section">
                <h2>üé≤ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–µ—Ä–µ–±—å—ë–≤–∫–æ–π</h2>

                {% if game.draws %}
                    <div class="draw-section">
                        <p>–ñ–µ—Ä–µ–±—å—ë–≤–∫–∞ —É–∂–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞. –ü–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.</p>
                    </div>
                {% else %}
                    <div class="draw-section">
                        <p>–ö–æ–≥–¥–∞ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∂–µ—Ä–µ–±—å—ë–≤–∫—É.</p>
                        <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ game.participants|length }}</strong></p>

                        {% if game.participants|length >= 3 %}
                        <form action="/game/{{ game.id }}/start-draw" method="POST"
                            onsubmit="return confirm('üéÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∂–µ—Ä–µ–±—å—ë–≤–∫—É? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —É–≤–∏–¥—è—Ç —Å–≤–æ–∏—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π!')">
                            <button type="submit" class="btn btn-primary btn-large">üé≤ –ù–∞—á–∞—Ç—å –∂–µ—Ä–µ–±—å—ë–≤–∫—É</button>
                        </form>
                        {% else %}
                        <div class="warning-message">
                            ‚ö†Ô∏è –î–ª—è –∂–µ—Ä–µ–±—å—ë–≤–∫–∏ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —É—á–∞—Å—Ç–Ω–∏–∫–∞
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
            </section>

            {% if game.draws %}
            <section class="content-section">
                <h2>üéÖ –ü–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
                <div class="pairs-list">
                    {% for participant in game.participants %}
                        {% if participant.assigned_to %}
                        <div class="pair-item">
                            <div class="santa">
                                <span class="user-avatar small">
                                {{ participant.user.username[0]|upper if participant.user.username else participant.user.email[0]|upper }}
                                </span>
                                <span class="user-name">{{ participant.user.username or participant.user.email }}</span>
                            </div>
                            <div class="pair-arrow">üéÅ ‚Üí</div>
                            <div class="receiver">
                                <span class="user-avatar small">
                                    {{ participant.assigned_to.user.username[0]|upper if participant.assigned_to.user.username else participant.assigned_to.user.email[0]|upper }}
                                </span>
                                <span class="user-name">{{ participant.assigned_to.user.username or participant.assigned_to.user.email }}</span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}
            {% endif %}
        </div>

        <div class="content-sections">
            <section class="content-section">
                <h2>üéÖ –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ game.participants|length }})</h2>
                <div class="participants-list">
                    {% if game.participants %}
                        {% for participant in game.participants %}
                        <div class="participant-item">
                            <div class="participant-avatar">
                                {{ participant.user.username[0]|upper if participant.user.username else participant.user.email[0]|upper }}
                            </div>
                            <div class="participant-info">
                                <span class="participant-name">
                                    {{ participant.user.username or participant.user.email }}
                                </span>
                                {% if participant.user_id == game.organizer_id %}
                                <span class="participant-role">üëë –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-participants">
                            <div class="empty-emoji">üéÑ</div>
                            <p>–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        </div>
                    {% endif %}
                </div>
            </section>
            {% if game.organizer_id == current_user.id %}
            <section class="content-section">
                <h2>‚ö° –î–µ–π—Å—Ç–≤–∏—è</h2>
                <div class="action-buttons-vertical">
                    <a href="/edit-game/{{ game.id }}" class="btn btn-outline btn-block">
                        üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π
                    </a>
                </div>
            </section>
            {% endif %}

            <section class="content-section">
                <h2>üìà –°—Ç–∞—Ç—É—Å</h2>
                <div class="game-progress">
                    <div class="progress-item {% if game.status == 'draft' %}active{% endif %}">
                        <div class="progress-step">1</div>
                        <span>–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                    </div>
                    <div class="progress-item {% if game.status == 'active' %}active{% endif %}">
                        <div class="progress-step">2</div>
                        <span>–ê–∫—Ç–∏–≤–Ω–∞</span>
                    </div>
                    <div class="progress-item {% if game.status == 'completed' %}active{% endif %}">
                        <div class="progress-step">3</div>
                        <span>–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyKey(keyText) {
    navigator.clipboard.writeText(keyText).then(() => {
        const btn = event.target;
        btn.textContent = '‚úÖ';
        setTimeout(() => {
            btn.textContent = 'üìã';
        }, 2000);
    });
}

// –¢–∞–π–º–µ—Ä –¥–æ –¥–∞—Ç—ã –∂–µ—Ä–µ–±—å–µ–≤–∫–∏
{% if game.event_date %}
function updateCountdown() {
    const eventDate = new Date('{{ game.event_date.strftime("%Y-%m-%dT%H:%M:%S") }}');
    const now = new Date();
    const diff = eventDate - now;
    
    if (diff > 0) {
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        document.getElementById('countdown').innerHTML = 
            `–î–æ –∂–µ—Ä–µ–±—å–µ–≤–∫–∏: ${days}–¥ ${hours}—á ${minutes}–º`;
    } else {
        document.getElementById('countdown').innerHTML = '–ñ–µ—Ä–µ–±—å–µ–≤–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å!';
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
updateCountdown();
setInterval(updateCountdown, 60000);
{% endif %}
</script>
{% endblock %}