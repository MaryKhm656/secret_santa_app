{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∏–≥—Ä—ã{% endblock %}

{% block content %}
<div class="content-container">
    <div class="games-header">
        <div class="header-content">
            <h1>üéÆ –ú–æ–∏ –∏–≥—Ä—ã</h1>
            <p>–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ —Ç–≤–æ–∏ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è!</p>
        </div>
        <div class="content-sections">
            <a href="/create-game" class="btn btn-primary btn-large">
                ‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
            </a>
            <a href="#" onclick="showJoinModal()" class="btn btn-primary btn-large">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</a>
        </div>
    </div>

    {% if new_game_key %}
    <div id="newGameModal" class="modal" style="display: flex;">
        <div class="modal-content success-content">
            <div class="success-header">
                <span class="success-emoji">üéâ</span>
                <h3>–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</h3>
            </div>
            
            <div class="success-info">
                <p>–¢–≤–æ—è –∏–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞! –í–æ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π:</p>
                
                <div class="secret-key-display">
                    <span class="key-label">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:</span>
                    <span class="key-value" id="generatedKey">{{ new_game_key }}</span>
                    <button class="btn-copy" onclick="copySecretKey()">üìã</button>
                </div>
                
                <div class="success-hint">
                    üí° –ü–æ–¥–µ–ª–∏—Å—å –∫–ª—é—á–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –º–æ–≥–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!
                </div>
            </div>
            
            <div class="modal-actions">
                <button onclick="closeNewGameModal()" class="btn btn-primary">
                    –ü–æ–Ω—è—Ç–Ω–æ!
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="filters-section">
        <button class="btn btn-outline" onclick="toggleFilters()" id="filtersToggle">
            üîç –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
        
        <div class="content-section" id="filtersContent" style="display: none;">
            <form method="GET" action="/games" class="content-sections">
                <div class="filter-group">
                    <label>–ú–æ—è —Ä–æ–ª—å:</label>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="radio" name="role" value="all" {% if current_role == 'all' %}checked{% endif %}>
                            <span>–í—Å–µ –∏–≥—Ä—ã</span>
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="role" value="organizer" {% if current_role == 'organizer' %}checked{% endif %}>
                            <span>–Ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="role" value="participant" {% if current_role == 'participant' %}checked{% endif %}>
                            <span>–Ø —É—á–∞—Å—Ç–Ω–∏–∫</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã:</label>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="radio" name="status" value="all" {% if current_status == 'all' %}checked{% endif %}>
                            <span>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</span>
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="status" value="draft" {% if current_status == 'draft' %}checked{% endif %}>
                            <span>–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</span>
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="status" value="active" {% if current_status == 'active' %}checked{% endif %}>
                            <span>–ê–∫—Ç–∏–≤–Ω—ã–µ</span>
                        </label>
                        <label class="filter-option">
                            <input type="radio" name="status" value="completed" {% if current_status == 'completed' %}checked{% endif %}>
                            <span>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</span>
                        </label>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <a href="/games" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </form>
        </div>
    </div>

    <div class="content-sections">
        {% if not games %}
        <div class="empty-state">
            <div class="empty-emoji">üéÅ</div>
            <h3>–ò–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É</p>
            <a href="/create-game" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</a>
        </div>
        {% else %}
            {% for game in games %}
            <div class="game-card">
                <div class="game-header">
                    <h3 class="game-title">{{ game.title }}</h3>
                    <div class="game-meta">
                        <span class="game-status status-{{ game.status }}">{{ game.status }}</span>
                        {% if game.organizer_id == current_user.id %}
                        <span class="game-role organizer">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                        {% else %}
                        <span class="game-role participant">–£—á–∞—Å—Ç–Ω–∏–∫</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if game.description %}
                <p class="game-description">{{ game.description }}</p>
                {% endif %}
                
                <div class="game-details">
                    <div class="detail-item">
                        <span class="detail-icon">üìÖ</span>
                        <span class="detail-text">
                            {% if game.event_date %}
                                {{ game.event_date.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                                –î–∞—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if game.budget %}
                    <div class="detail-item">
                        <span class="detail-icon">üí∞</span>
                        <span class="detail-text">–ë—é–¥–∂–µ—Ç: {{ game.budget }} —Ä—É–±.</span>
                    </div>
                    {% endif %}
                    
                    <div class="detail-item">
                        <span class="detail-icon">üîê</span>
                        <span class="detail-text">
                            {% if game.is_private %}
                                –ü—Ä–∏–≤–∞—Ç–Ω–∞—è
                            {% else %}
                                –ü—É–±–ª–∏—á–Ω–∞—è
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="form-actions">
                    <a href="/game/{{ game.id }}" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–≥—Ä–µ</a>
                    {% if game.organizer_id == current_user.id %}
                    <a href="/edit-game/{{ game.id }}" class="btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form action="/delete-game/{{ game.id }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn"
                                onclick="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')">
                        –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>
</div>
    </div><div id="joinGameModal" class="modal">
    <div class="modal-content join-modal">
        <div class="modal-header">
            <h3>üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</h3>
            <button class="close-btn" onclick="closeJoinModal()">&times;</button>
        </div>

        <form method="POST" action="/join-game" id="joinForm">
            <div class="form-group">
                <label for="secret_key">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–≥—Ä—ã</label>
                <input type="text" id="secret_key" name="secret_key"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –¥–∞–ª–∏"
                       required maxlength="10"
                       pattern="[A-Za-z0-9]+"
                       title="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã">
                <div class="form-hint">–ö–ª—é—á —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä</div>
            </div>

            <div id="joinError" class="error-message" style="display: none;"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeJoinModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleFilters() {
    const filtersContent = document.getElementById('filtersContent');
    const filtersToggle = document.getElementById('filtersToggle');
    
    if (filtersContent.style.display === 'none') {
        filtersContent.style.display = 'block';
        filtersToggle.innerHTML = '‚úñÔ∏è –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã';
        filtersToggle.classList.add('active');
    } else {
        filtersContent.style.display = 'none';
        filtersToggle.innerHTML = 'üîç –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã';
        filtersToggle.classList.remove('active');
    }
}

window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('role') || urlParams.get('status')) {
        toggleFilters();
    }
});

function closeNewGameModal() {
    document.getElementById('newGameModal').style.display = 'none';
    document.cookie = "new_game_key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
}

function copySecretKey() {
    const keyElement = document.getElementById('generatedKey');
    const keyText = keyElement.textContent;
    
    navigator.clipboard.writeText(keyText).then(() => {
        const btn = document.querySelector('.btn-copy');
        btn.textContent = '‚úÖ';
        setTimeout(() => {
            btn.textContent = 'üìã';
        }, 2000);
    });
}

window.onclick = function(event) {
    const modal = document.getElementById('newGameModal');
    if (event.target === modal) {
        closeNewGameModal();
    }
}
    function showJoinModal() {
    document.getElementById('joinGameModal').style.display = 'flex';
    document.getElementById('secret_key').focus();
}

function closeJoinModal() {
    document.getElementById('joinGameModal').style.display = 'none';
    document.getElementById('joinError').style.display = 'none';
}

document.getElementById('joinForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const errorDiv = document.getElementById('joinError');

    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è...';
    errorDiv.style.display = 'none';

    try {
        const response = await fetch('/join-game', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const message = await response.text();
            alert(message);
            closeJoinModal();
            setTimeout(() => window.location.reload(), 500);
        }
    } catch (error) {
        errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        errorDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('joinGameModal');
    if (event.target === modal) {
        closeJoinModal();
    }
}
</script>
{% endblock %}