{% extends "base.html" %}


{% block content %}
<div class="welcome-container">
    <h1>–•–æ-–•–æ-–•–æ!</h1>
    <p>–°–∫–æ—Ä–æ –ù–æ–≤—ã–π –ì–æ–¥, –∞ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –≤—Ä–µ–º—è –¥–∞—Ä–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏!</p>
    <p>–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞—à–∏–º —É–¥–æ–±–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º —Å –¥—Ä—É–∑—å—è–º–∏, –∫–æ–ª–ª–µ–≥–∞–º–∏, —Å–µ–º—å–µ–π, —á—Ç–æ–±—ã –ø—Ä–∞–∑–¥–Ω–∏–∫ –ø—Ä–æ—à–µ–ª –Ω–µ–∑–∞–±—ã–≤–∞–µ–º–æ!</p>
  {% if current_user %}
    <div class="buttons">
      <a href="#" onclick="showJoinModal()"><button class="btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</button></a>
      <a href="/create-game"><button class="btn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button></a>
      <a href="/games"><button class="btn">–ú–æ–∏ –∏–≥—Ä—ã</button></a>
    </div>
  {% else %}
    <div class="buttons">
      <a href="/login"><button class="btn">–í–æ–π—Ç–∏</button> </a>
      <a href="/register"><button class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button> </a>
    </div>
  {% endif %}
</div>
    </div><div id="joinGameModal" class="modal">
    <div class="modal-content join-modal">
        <div class="modal-header">
            <h3>üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</h3>
            <button class="close-btn" onclick="closeJoinModal()">‚ùå</button>
        </div>

        <form method="POST" action="/join-game" id="joinForm">
            <div class="form-group">
                <label for="secret_key">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–≥—Ä—ã</label>
                <input type="text" id="secret_key" name="secret_key"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –¥–∞–ª–∏"
                       required maxlength="10"
                       pattern="[A-Za-z0-9]+"
                       title="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã">
                <div class="form-hint">–ö–ª—é—á —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä</div>
            </div>

            <div id="joinError" class="error-message" style="display: none;"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeJoinModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function showJoinModal() {
    document.getElementById('joinGameModal').style.display = 'flex';
    document.getElementById('secret_key').focus();
}

function closeJoinModal() {
    document.getElementById('joinGameModal').style.display = 'none';
    document.getElementById('joinError').style.display = 'none';
}

document.getElementById('joinForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const errorDiv = document.getElementById('joinError');

    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è...';
    errorDiv.style.display = 'none';

    try {
        const response = await fetch('/join-game', {
            method: 'POST',
            body: formData
        });

        const message = await response.text();

        if (response.ok) {
            alert(message);
            closeJoinModal();
            setTimeout(() => window.location.reload(), 500);
        } else {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

    } catch (error) {
        errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        errorDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
    }
});

window.onclick = function(event) {
    const modal = document.getElementById('joinGameModal');
    if (event.target === modal) {
        closeJoinModal();
    }
}
</script>
{% endblock %}