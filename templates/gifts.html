{% extends "base.html" %}
{% block title %}–ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏ - Secret Santa{% endblock %}

{% block content %}
<div class="content-container">

    <div class="content-header">
        <h1>üéÅ –ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</h1>
        <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏ –≤–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –∏–≥—Ä–∞—Ö</p>
    </div>

    <div class="content-sections">
        <section class="content-section">
            <h2>üì¶ –ü–æ–¥–∞—Ä–∫–∏ –¥–ª—è –º–µ–Ω—è</h2>
            <p class="section-description">–ü–æ–¥–∞—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ç–æ–≤—è—Ç –≤–∞–º –¥—Ä—É–≥–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</p>

            {% if games_data %}
            <div class="content-list">

                {% for data in games_data %}
                {% set gift = data.gift_for_me %}
                {% if gift or (data.participation.assigned_to_id and data.game.status == 'active') %}

                <div class="content-item-section">

                    <div class="game-header">
                        <h3>üéÆ {{ data.game.title }}</h3>
                        <span class="game-status status-{{ data.game.status }}">
                            {{ data.game.status }}
                        </span>
                    </div>

                    <div class="content-sections">

                        {% if gift %}
                        <div class="gift-info received">

                            <div class="gift-header">
                                <h4>{{ gift.title }}</h4>
                                <span class="gift-status status-{{ gift.status }}">
                                    {% if gift.status == 'planned' %}üìù –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                                    {% elif gift.status == 'sent' %}üöö –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
                                    {% elif gift.status == 'received' %}üéâ –ü–æ–ª—É—á–µ–Ω
                                    {% endif %}
                                </span>
                            </div>

                            {% if gift.description %}
                            <p class="gift-description">{{ gift.description }}</p>
                            {% endif %}

                            {% if gift.price %}
                            <div class="gift-price">üí∞ {{ gift.price }} —Ä—É–±.</div>
                            {% endif %}

                            <div class="gift-meta">
                                <span class="meta-item">
                                    üìÖ –°–æ–∑–¥–∞–Ω: {{ gift.created_at.strftime('%d.%m.%Y') }}
                                </span>
                            </div>

                            <div class="gift-message">
                                {% if gift.status == 'planned' %}
                                üéÖ –í–∞—à –°–∞–Ω—Ç–∞ —É–∂–µ –ø—Ä–∏–¥—É–º–∞–ª, —á—Ç–æ –≤–∞–º –ø–æ–¥–∞—Ä–∏—Ç—å!
                                {% elif gift.status == 'sent' %}
                                üìÆ –ü–æ–¥–∞—Ä–æ–∫ —É–∂–µ –≤ –ø—É—Ç–∏!
                                {% elif gift.status == 'received' %}
                                üéâ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫!
                                {% endif %}
                            </div>

                        </div>

                        {% else %}
                        <div class="no-gift-message">
                            <div class="message-emoji">‚è≥</div>
                            <p>–í–∞—à –°–∞–Ω—Ç–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª –ø–æ–¥–∞—Ä–æ–∫</p>
                            <p class="hint">–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è ‚Äî –æ–Ω –±—É–¥–µ—Ç –∑–¥–µ—Å—å</p>
                        </div>
                        {% endif %}

                    </div>

                </div>
                {% endif %}
                {% endfor %}

            </div>
            {% else %}
            <div class="empty-gifts">
                <div class="empty-emoji">üéÑ</div>
                <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏</h3>
                <p>–ü–æ—Å–ª–µ –∂–µ—Ä–µ–±—å—ë–≤–∫–∏ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥–∞—Ä–∫–∏</p>
            </div>
            {% endif %}
        </section>
        <section class="content-section">
            <h2>üéÖ –ü–æ–¥–∞—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —è –¥–∞—Ä—é</h2>
            <p class="section-description">–ü–æ–¥–∞—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≥–æ—Ç–æ–≤–∏—Ç–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>

            {% if games_data %}
            <div class="content-list">

                {% for data in games_data %}
                {% set gift = data.my_gift %}
                {% set receiver_user = data.participation.assigned_to.user if data.participation.assigned_to else None %}

                {% if receiver_user and data.game.status == 'active' %}

                <div class="content-item-section">

                    <div class="game-header">
                        <h3>üéÆ {{ data.game.title }}</h3>
                        <span class="game-status status-{{ data.game.status }}">
                            {{ data.game.status }}
                        </span>
                    </div>

                    <div class="content-sections">

                        {% if gift %}
                        <div class="gift-info given">

                            <div class="gift-header">
                                <h4>{{ gift.title }}</h4>
                                <span class="gift-status status-{{ gift.status }}">
                                    {% if gift.status == 'planned' %}üìù –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                                    {% elif gift.status == 'sent' %}üöö –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
                                    {% elif gift.status == 'received' %}üéâ –ü–æ–ª—É—á–µ–Ω
                                    {% endif %}
                                </span>
                            </div>

                            {% if gift.description %}
                            <p class="gift-description">{{ gift.description }}</p>
                            {% endif %}

                            {% if gift.price %}
                            <div class="gift-price">üí∞ {{ gift.price }} —Ä—É–±.</div>
                            {% endif %}

                            <div class="gift-receiver">
                                <strong>–î–ª—è:</strong> {{ receiver_user.username or receiver_user.email }}
                                {% if receiver_user.wishlist %}
                                <div class="wishlist-hint">üí° –í–∏—à–ª–∏—Å—Ç: {{ receiver_user.wishlist }}</div>
                                {% endif %}
                            </div>

                            <div class="gift-meta">
                                <span class="meta-item">
                                    üìÖ –°–æ–∑–¥–∞–Ω: {{ gift.created_at.strftime('%d.%m.%Y') }}
                                </span>
                                {% if gift.sent_at %}
                                <span class="meta-item">
                                    üìÆ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω: {{ gift.sent_at.strftime('%d.%m.%Y') }}
                                </span>
                                {% endif %}
                                {% if gift.received_at %}
                                <span class="meta-item">
                                    üéâ –ü–æ–ª—É—á–µ–Ω: {{ gift.received_at.strftime('%d.%m.%Y') }}
                                </span>
                                {% endif %}
                            </div>

                            <div class="gift-actions">
                                <form action="/gifts/{{ gift.id }}/update-status" method="POST" class="status-form">
                                    <select name="new_status" class="form-select" onchange="this.form.submit()">
                                        <option value="planned"  {% if gift.status == 'planned' %}selected{% endif %}>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</option>
                                        <option value="sent"     {% if gift.status == 'sent' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                                        <option value="received" {% if gift.status == 'received' %}selected{% endif %}>–ü–æ–ª—É—á–µ–Ω</option>
                                    </select>
                                    </form>

                                <a href="/gifts/{{ gift.id }}/edit" class="btn btn-outline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                <form action="/gifts/{{ gift.id }}/delete" method="POST" style="display: inline;">
                                    <button type="submit" class="btn"
                                    onclick="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')">
                                    –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </form>
                            </div>

                        </div>

                        {% else %}
                        <div class="no-gift-message">
                            <div class="message-emoji">üéÅ</div>
                            <p>–í—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è</p>
                            <p class="receiver-name">
                                <strong>{{ receiver_user.username or receiver_user.email }}</strong>
                            </p>

                            {% if receiver_user.wishlist %}
                            <div class="wishlist-preview">
                                <strong>üéØ –í–∏—à–ª–∏—Å—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</strong>
                                <p>{{ receiver_user.wishlist }}</p>
                            </div>
                            {% endif %}

                            <a href="/game/{{ data.game.id }}/create-gift" class="btn btn-primary">
                                üéÅ –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫
                            </a>
                        </div>
                        {% endif %}

                    </div>
                </div>

                {% endif %}
                {% endfor %}
            </div>

            {% else %}
            <div class="empty-gifts">
                <div class="empty-emoji">üéÅ</div>
                <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤</h3>
                <p>–ü–æ—Å–ª–µ –∂–µ—Ä–µ–±—å—ë–≤–∫–∏ –≤ –≤–∞—à–∏—Ö –∏–≥—Ä–∞—Ö –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏</p>
            </div>
            {% endif %}
        </section>

    </div>
</div>
{% endblock %}